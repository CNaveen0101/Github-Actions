name: newfiles

on:
  push:
   branches: main

jobs:
 setup:
  runs-on: nrunnerlabel

  steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: Javainstall
    uses: actions/setup-java@v4
    with:
     distribution: temurin
     java-version: 17
     cache: maven

 test:
  runs-on: nrunnerlabel
  needs: setup

  steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: unittest
    run: mvn test
    
  - name: Trivy Installation
    run: |
      sudo apt-get install -y wget apt-transport-https gnupg lsb-release
      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
      echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
      sudo apt-get update -y
      sudo apt-get install -y trivy

  - name: Trivy FS Scan
    run: trivy fs --format table -o fs-report.json .

  - name: SonarQube Scan
    uses: SonarSource/sonarqube-scan-action@v5.0.0
    env:
     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
     SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}

  - name: Compiling
    run: mvn package

  - name: upload
    uses: actions/upload-artifact@v4
    with:
     name: bankapp
     path: target/*.jar

  - name: Download JAR artifact
    uses: actions/download-artifact@v4
    with:
      name: bankapp
      path: app  # This creates the /app folder Docker is looking fo

